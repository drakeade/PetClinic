pipeline {
    
    agent { label 'test' } 
    options {
        buildDiscarder logRotator(artifactDaysToKeepStr: '', artifactNumToKeepStr: '', daysToKeepStr: '', numToKeepStr: '10')
        disableConcurrentBuilds()
        timestamps()
    }
    stages {
        stage('Code Checkout'){
            steps {
                echo "code checkout"
                git credentialsId: 'github-creds', url: 'https://github.com/gopishank/PetClinic.git'
            }
        }
        
        stage('Code Build'){
            steps {
                sh "mvn test-compile"
            }
        }
        
        stage('Code Analysis & Unit Tests'){
            failFast true
            parallel {
                stage('Unit test') {
                    steps {
                        sh "mvn test"
                    }
                }
                stage('SonarQube Scan'){
                    steps {
                        withSonarQubeEnv (installationName: 'sq1') {
                            sh "./mvn clean sonar:sonar"
                        }
                    }
                }
            }
        }
        stage('Code Package'){
            steps {
                sh "mvn package"
            }
        }
        
